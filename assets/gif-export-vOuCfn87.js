import{r as R,u as v,a as C,_ as $,j as O,F as B,S as y,B as k,b as F,g as G}from"./components-BS_PgHiH.js";var o;(function(r){r.LOAD="LOAD",r.EXEC="EXEC",r.FFPROBE="FFPROBE",r.WRITE_FILE="WRITE_FILE",r.READ_FILE="READ_FILE",r.DELETE_FILE="DELETE_FILE",r.RENAME="RENAME",r.CREATE_DIR="CREATE_DIR",r.LIST_DIR="LIST_DIR",r.DELETE_DIR="DELETE_DIR",r.ERROR="ERROR",r.DOWNLOAD="DOWNLOAD",r.PROGRESS="PROGRESS",r.LOG="LOG",r.MOUNT="MOUNT",r.UNMOUNT="UNMOUNT"})(o||(o={}));const P=(()=>{let r=0;return()=>r++})(),T=new Error("ffmpeg is not loaded, call `await ffmpeg.load()` first"),j=new Error("called FFmpeg.terminate()");class W{#t=null;#a={};#r={};#o=[];#n=[];loaded=!1;#s=()=>{this.#t&&(this.#t.onmessage=({data:{id:e,type:t,data:a}})=>{switch(t){case o.LOAD:this.loaded=!0,this.#a[e](a);break;case o.MOUNT:case o.UNMOUNT:case o.EXEC:case o.FFPROBE:case o.WRITE_FILE:case o.READ_FILE:case o.DELETE_FILE:case o.RENAME:case o.CREATE_DIR:case o.LIST_DIR:case o.DELETE_DIR:this.#a[e](a);break;case o.LOG:this.#o.forEach(s=>s(a));break;case o.PROGRESS:this.#n.forEach(s=>s(a));break;case o.ERROR:this.#r[e](a);break}delete this.#a[e],delete this.#r[e]})};#e=({type:e,data:t},a=[],s)=>this.#t?new Promise((d,u)=>{const l=P();this.#t&&this.#t.postMessage({id:l,type:e,data:t},a),this.#a[l]=d,this.#r[l]=u,s?.addEventListener("abort",()=>{u(new DOMException(`Message # ${l} was aborted`,"AbortError"))},{once:!0})}):Promise.reject(T);on(e,t){e==="log"?this.#o.push(t):e==="progress"&&this.#n.push(t)}off(e,t){e==="log"?this.#o=this.#o.filter(a=>a!==t):e==="progress"&&(this.#n=this.#n.filter(a=>a!==t))}load=({classWorkerURL:e,...t}={},{signal:a}={})=>(this.#t||(this.#t=e?new Worker(new URL(e,import.meta.url),{type:"module"}):new Worker(new URL("/bendor/assets/worker-BAOIWoxA.js",import.meta.url),{type:"module"}),this.#s()),this.#e({type:o.LOAD,data:t},void 0,a));exec=(e,t=-1,{signal:a}={})=>this.#e({type:o.EXEC,data:{args:e,timeout:t}},void 0,a);ffprobe=(e,t=-1,{signal:a}={})=>this.#e({type:o.FFPROBE,data:{args:e,timeout:t}},void 0,a);terminate=()=>{const e=Object.keys(this.#r);for(const t of e)this.#r[t](j),delete this.#r[t],delete this.#a[t];this.#t&&(this.#t.terminate(),this.#t=null,this.loaded=!1)};writeFile=(e,t,{signal:a}={})=>{const s=[];return t instanceof Uint8Array&&s.push(t.buffer),this.#e({type:o.WRITE_FILE,data:{path:e,data:t}},s,a)};mount=(e,t,a)=>{const s=[];return this.#e({type:o.MOUNT,data:{fsType:e,options:t,mountPoint:a}},s)};unmount=e=>{const t=[];return this.#e({type:o.UNMOUNT,data:{mountPoint:e}},t)};readFile=(e,t="binary",{signal:a}={})=>this.#e({type:o.READ_FILE,data:{path:e,encoding:t}},void 0,a);deleteFile=(e,{signal:t}={})=>this.#e({type:o.DELETE_FILE,data:{path:e}},void 0,t);rename=(e,t,{signal:a}={})=>this.#e({type:o.RENAME,data:{oldPath:e,newPath:t}},void 0,a);createDir=(e,{signal:t}={})=>this.#e({type:o.CREATE_DIR,data:{path:e}},void 0,t);listDir=(e,{signal:t}={})=>this.#e({type:o.LIST_DIR,data:{path:e}},void 0,t);deleteDir=(e,{signal:t}={})=>this.#e({type:o.DELETE_DIR,data:{path:e}},void 0,t)}var A;(function(r){r.MEMFS="MEMFS",r.NODEFS="NODEFS",r.NODERAWFS="NODERAWFS",r.IDBFS="IDBFS",r.WORKERFS="WORKERFS",r.PROXYFS="PROXYFS"})(A||(A={}));const M=new Error("failed to get response body reader"),Q=new Error("failed to complete download"),X="Content-Length",Y=async(r,e)=>{const t=await fetch(r);let a;try{const s=parseInt(t.headers.get(X)||"-1"),d=t.body?.getReader();if(!d)throw M;const u=[];let l=0;for(;;){const{done:E,value:g}=await d.read(),w=g?g.length:0;if(E){if(s!=-1&&s!==l)throw Q;e&&e({url:r,total:s,received:l,delta:w,done:E});break}u.push(g),l+=w,e&&e({url:r,total:s,received:l,delta:w,done:E})}const h=new Uint8Array(l);let f=0;for(const E of u)h.set(E,f),f+=E.length;a=h.buffer}catch(s){console.log("failed to send download progress event: ",s),a=await t.arrayBuffer()}return a},S=async(r,e,t=!1,a)=>{const s=t?await Y(r,a):await(await fetch(r)).arrayBuffer(),d=new Blob([s],{type:e});return URL.createObjectURL(d)},H={framerate:15,compressionQuality:100,colorRange:80},q=()=>{const r=R.useRef(new W),e=R.useRef(null),t=R.useRef(!1),{state:a,dispatch:s}=v(),{start:d,stop:u}=C(),[l,h]=R.useState(!1),[f,E]=R.useState(H);R.useEffect(()=>{t.current||(d(),(async()=>{try{const i="https://unpkg.com/@ffmpeg/core@0.12.6/dist/esm";await r.current.load({coreURL:await S(`${i}/ffmpeg-core.js`,"text/javascript"),wasmURL:await S(`${i}/ffmpeg-core.wasm`,"application/wasm")}),console.info("ffmpeg loaded");const c=await $(()=>import("./gifsicle.min-DlEdYrSW.js"),[]);e.current=c.default,console.info("gifsicle loaded"),t.current=!0}catch(i){console.error("Failed to load libraries:",i)}finally{u()}})())},[d,u]);const g=async i=>{if(!e.current)return console.warn("gifsicle not loaded, skipping compression"),i;try{const c=new File([i],"temp.gif",{type:"image/gif"}),L=["-O1",`--lossy=${f.compressionQuality*2}`,`--colors=${f.colorRange}`,"temp.gif","-o","/out/compressed.gif","--no-warnings"],m=await e.current.run({input:[{file:c,name:"temp.gif"}],command:[L.join(" ")]});return m&&m.length>0?m[0]:i}catch(c){return console.error("GIF compression failed:",c),i}},w=async()=>{if(!t.current){console.warn("Libraries not loaded yet");return}if(d(),h(!0),!a.imgCtx)return;const i=r.current;if(!i.loaded){console.warn("cant export, ffmpeg is not loaded");return}try{const c=[],L=()=>new Promise((n,p)=>{requestAnimationFrame(()=>{a.imgCtx?.canvas.toBlob(_=>{_?n(_):p(new Error("Failed to capture frame"))})})});c.push(await L()),s({type:F.ResetImageCanvas});for(let n=0;n<f.framerate-1;n++){s({type:F.ResetImageCanvas}),s({type:F.GenerateResult,payload:{refreshIdx:-1}});try{const p=await L();c.push(p)}catch(p){throw console.error(`Error capturing frame ${n+2}:`,p),new Error(`Frame capture failed at frame ${n+2}`)}}if(console.info(`captured ${c.length} frames total`),c.length!==f.framerate)throw new Error(`Expected ${f.framerate} frames but got ${c.length}`);try{for(let n=0;n<c.length;n++){const p=await c[n].arrayBuffer(),_=`frame${n.toString().padStart(3,"0")}.png`;await i.writeFile(_,new Uint8Array(p))}}catch(n){throw console.error("FFmpeg writeFile error:",n),new Error(`FFmpeg write failed: ${n}`)}try{await i.exec(["-framerate",`${f.framerate}`,"-i","frame%03d.png","-vf",`split[s0][s1];[s0]palettegen=max_colors=${f.colorRange}[p];[s1][p]paletteuse=dither=bayer:bayer_scale=5`,"output.gif"])}catch(n){throw console.error("FFmpeg exec error:",n),new Error(`FFmpeg encoding failed: ${n}`)}let m;try{m=await i.readFile("output.gif")}catch(n){throw console.error("FFmpeg readFile error:",n),new Error(`FFmpeg read failed: ${n}`)}let D=new Blob([m.slice(0)],{type:"image/gif"});try{D=await g(D)}catch(n){console.error("Gifsicle compression error:",n),console.warn("continuing with uncompressed GIF...")}const N=await D.arrayBuffer(),U=await G(N),x=URL.createObjectURL(D),I=document.createElement("a");I.href=x,I.download=`${U}.gif`,I.click(),URL.revokeObjectURL(x);try{for(let n=0;n<c.length;n++)await i.deleteFile(`frame${n.toString().padStart(3,"0")}.png`);await i.deleteFile("output.gif")}catch(n){console.warn("cleanup error (non-critical):",n)}}catch(c){console.error("GIF Export failed:",c)}finally{h(!1),u()}},b=!t.current||l;return O.jsxs(B,{direction:"col",children:[O.jsx(y,{label:"GIF Frame Rate",id:"framerate",min:5,max:30,value:f.framerate,onChange:i=>E(c=>({...c,framerate:parseFloat(i.target.value)}))}),O.jsx(y,{label:"Color Range",id:"colorRange",min:80,max:256,value:f.colorRange,onChange:i=>E(c=>({...c,colorRange:parseFloat(i.target.value)}))}),O.jsx(y,{label:"Quality",id:"compressionQuality",min:0,max:100,value:f.compressionQuality,onChange:i=>E(c=>({...c,compressionQuality:parseFloat(i.target.value)}))}),O.jsx(k,{$full:!0,onClick:w,disabled:b,variant:b?"disabled":"primary",children:t.current?l?"Exporting...":"Export":"Loading..."})]})};export{q as default};
